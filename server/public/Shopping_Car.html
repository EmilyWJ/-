<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/shopping_car.css">
    <link rel="stylesheet" href="CSS/main.css">
    <title>购物车页-欢乐购</title>
</head>
<body>
  <div class="home">
    <header id="head">
    </header>
    <div class="shoppingbox">
      <h3 class="">
          <span class="c1">我的购物车<i id="si"></i></span>
          <span class="c2" style="font-size: 12px">配送至</span>
          <select name="" id="s1">
              <option value="" class="o1">上海/黄浦区</option>
          </select>
      </h3>
      <div class="d3" id="d3">
        <div class="head1">
          <input id="l1" type="checkbox">
          <div class="col6">全选</div>
          <div class="col1">商品信息</div>
          <div class="col2">单价（元）</div>
          <div class="col3">数量</div>
          <div class="col4">金额（元）</div>
          <div class="col5">操作</div>
        </div>
        <div class="d3" id="d4">

        </div>
      </div>
      <div class="d4">
          <span class="d4s1">活动优惠：-￥0.00</span>
          <span class="d4s2" id="d466">商品应付总计：￥0</span>
          <span class="d4s3">预估税费：￥0.00</span>
      </div>
      <div class="d5">
        <div class="d5d1">
          <input type="checkbox">
          <span style="font-size: 13px;">全选</span>
          <a href="#">删除选中商品</a>
        </div>
        <div class="d5d2">
          <span class="d5d2p1">已选商品 <em class="d5d2e1"> 0 </em> 件</spam>
          <span class="d5d2p2">总价（不含运费）：<em class="d5d2e2"></em></span>
        </div>
        <div class="d5d3">
          <span class="d5s1">活动优惠：-￥0.00</span>
          <span class="d5s2" id="d522"></span>
          <span class="d5s3">商品税费（不含运费税）：￥0.00</span>
        </div>
          <a href="#" class="d5a1">去结算</a>
      </div>
  </div>
  <footer class="floor">
  </footer>
</div>
<script src="JS/jquery-3.4.1.min.js"></script>
<script src="JS/main.js"></script>
<script>
  //  页面加载就执行此函数
  window.onload=function(){
  //  创建异步对象
  var xhr=new XMLHttpRequest();
    // 绑定监听，监听请求是否发送
    xhr.onreadystatechange=function(){
    // 判断当前异步请求的状态
    if(xhr.readyState==4 && xhr.status==200){
    // 接收服务器传过来的数据并将格式转成json对象
      var res=JSON.parse(xhr.responseText);
      console.log(res);
      let len=res.length;
      si.innerHTML=len;
        // 把数据一一放入对应的标签中
      for (let i = 0; i < len; i++) {
        d4.innerHTML+=`
          <ul class="d3u1">
              <li class="d3l1">
                <div class="d3d1">
                  <input type="checkbox" id="i3">
                </div>
                <div class="d3d2">
                  <a href="#" class="d3a1">
                    <img src="${res[i].details}" alt="">
                  </a>
                </div>
                <div class="d3d3">
                  <a href="#" class="d3a2">${res[i].title}</a> 
                  <p class="d3p1"><img src="images/shopcar/shoppingcar2.png" alt="">支持7天无忧退货
                  </p>
                  <p>
                    <span class="d3p2">
                      特价 <a class="d3p3">^</a>
                    </span>
                  </p>
                </div>
                <div class="d3d4">颜色：黑色</div>
                <div class="d3d5">
                  <p class="d3d5p1">${res[i].p_price}</p>
                  <p class="d3d5p2" id="price">${res[i].price}</p>
                </div>
                <div class="d3d6">
                  <button class="d3d6b1">-</button>
                  <input type="text" class="d3d6i1" value='1'>
                  <button class="d3d6b2">+</button>
                  <p class="d3d6p1">仅剩9件</p>
                </div>
                <div class="d3d7" id="d1">${res[i].price}</div>
                <div class="d3d8">
                  <a href="#">删除</a>
                  <br>
                  <a href="#">移入我的收藏</a>
                </div>
              </li>
            </ul>
          `;
        }
      }
    }
    // 数据是其他格式的，需要转换成对象
    var lid=location.search.split('=')[1];
    // 打开连接，请求方法为get和路由方法的请求方式要保持一致，通过id获取对应的数据，所以需要将id传给服务器
    xhr.open("get","/shopping_car/shop?id="+sessionStorage["id"],true);
    // 发送请求
    xhr.send();
    //     
    // var btns=document.querySelectorAll(".d3d6 button");
    var bt=document.getElementsByClassName("d3")[0];
    var btc=bt.children;
  }

  let d3=document.getElementById('d3');
  d3.onclick=function(e){
    // 1.input 加减
    let d3=this;
    let btns=e.target;
    let total=0;
    let count=1;
    let input=btns.parentNode.children[1];
    if(btns.nodeName=='BUTTON'){
        count=input.value;//数量
      if(btns.innerHTML=='+'){
        if(count<9)
          count++;
      }else{
        if(count>1)
          count--;
      }
      input.value=count;
      let price=btns.parentNode.nextElementSibling;
      let dprice=parseInt(btns.parentNode.previousElementSibling.children[1].innerHTML);
      total=input.value*dprice;
      price.innerHTML=total;
    }
    // 2.总价
    let spans=d3.querySelectorAll('.d3d7');
    let sum=0;
    for(var s of spans){
      sum+=parseInt(s.innerHTML);
    }
    var chbs=d4.querySelectorAll("input[type=checkbox]");
    // console.log(chbs);
    // for (const chb of chbs) {
    //   if(chb.checked==true){
    //     var cnum=chb.parentNode.parentNode.children[5];
    //     var num=chb.parentNode.parentNode.getElementsByClassName("d3d6i1")[0];
    //     console.log(num);
    //   }
    // }
    var nu=0;
    var pri=0;
    var su=document.getElementsByClassName("d5d2e1")[0];
    var sup=document.getElementsByClassName("d5d2e2")[0];
    for (var i=0;i<chbs.length;i++) {
      // console.log(chbs);
      if(chbs[i].checked==true){
        // console.log(i);
        var cnum=chbs[i].parentNode.parentNode.children[5];
        var num=chbs[i].parentNode.parentNode.getElementsByClassName("d3d6i1")[0].value;
        var pric=chbs[i].parentNode.parentNode.getElementsByClassName("d3d7")[0].innerHTML;
        // console.log(num,pric);
        nu+=parseInt(num);
        pri+=parseInt(pric);
      }
    }
    l1.onclick=function(){
      if(l1.checked){
        console.log(chbs);
        for (const ch of chbs) {
          ch.setAttribute("checked","true");
          console.log(ch.checked);
        }
      }else{
        for (var ch of chbs) {
          console.log(ch.checked);
          ch.removeAttribute("checked");
        }
      }
    }
    // console.log(nu,pri);
    su.innerHTML=nu;
    sup.innerHTML=pri;
    // let span=spans.innerHTML.slice(-1);

    // spans.innerHTML=`商品应付总计：￥${total}`

    // 2.总件数
    // let em=document.querySelector('.d5d2e1');
    // 先找每个input的单件数量
    // let inps=d3.querySelectorAll('.d3d6i1');
    // let sum=0;
    // for(var inp of inps){
    //   sum+=parseInt(inp.value);
    // }
    // em.innerHTML=sum;
  }
  </script>
</body>
</html>